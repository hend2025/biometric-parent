# Biometric Recognition System

åŸºäº Hazelcast çš„åˆ†å¸ƒå¼äººè„¸è¯†åˆ«ç³»ç»Ÿï¼Œæ”¯æŒå¤§è§„æ¨¡1:Näººè„¸è¯†åˆ«å’Œåˆ†å¸ƒå¼æ•°æ®åŠ è½½ã€‚

## é¡¹ç›®ç»“æ„

```
biometric-parent/
â”œâ”€â”€ biometric-algo/          # ç®—æ³•æ¨¡å— - äººè„¸è¯†åˆ«æ ¸å¿ƒç®—æ³•
â”‚   â”œâ”€â”€ aggregator/          # Hazelcast èšåˆå™¨
â”‚   â”œâ”€â”€ config/              # Hazelcast é…ç½®
â”‚   â”œâ”€â”€ dto/                 # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ model/               # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ service/             # è¯†åˆ«æœåŠ¡
â”‚   â””â”€â”€ util/                # å·¥å…·ç±»
â””â”€â”€ biometric-serv/          # ä¸šåŠ¡æ¨¡å— - RESTful API æœåŠ¡
    â”œâ”€â”€ controller/          # æ§åˆ¶å™¨
    â”œâ”€â”€ entity/              # æ•°æ®åº“å®ä½“
    â”œâ”€â”€ listener/            # åº”ç”¨ç›‘å¬å™¨
    â”œâ”€â”€ mapper/              # MyBatis Mapper
    â”œâ”€â”€ service/             # ä¸šåŠ¡æœåŠ¡
    â””â”€â”€ vo/                  # è§†å›¾å¯¹è±¡
```

## æ ¸å¿ƒç‰¹æ€§

### ğŸš€ åˆ†å¸ƒå¼æ¶æ„
- åŸºäº Hazelcast çš„åˆ†å¸ƒå¼å†…å­˜æ•°æ®ç½‘æ ¼
- è‡ªåŠ¨èŠ‚ç‚¹å‘ç°å’Œé›†ç¾¤ç»„å»º
- æ•°æ®è‡ªåŠ¨åˆ†ç‰‡å’Œå¤‡ä»½

### ğŸ¯ æ™ºèƒ½åŠ è½½
- **è‡ªåŠ¨èŠ‚ç‚¹IDæ£€æµ‹** - æ— éœ€æ‰‹åŠ¨é…ç½®èŠ‚ç‚¹ID
- **æ•°æ®åˆ†ç‰‡åŠ è½½** - æ¯ä¸ªèŠ‚ç‚¹åªåŠ è½½è‡ªå·±è´Ÿè´£çš„æ•°æ®
- **é›¶é…ç½®å·®å¼‚** - æ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨ç›¸åŒé…ç½®æ–‡ä»¶

### âš¡ é«˜æ€§èƒ½è¯†åˆ«
- 1:N äººè„¸è¯†åˆ«
- åˆ†å¸ƒå¼å¹¶è¡Œè®¡ç®—
- TopN ç»“æœèšåˆ

## æŠ€æœ¯æ ˆ

- **Java 8+**
- **Spring Boot 2.x**
- **Hazelcast 4.x** - åˆ†å¸ƒå¼å†…å­˜æ•°æ®ç½‘æ ¼
- **MyBatis Plus** - ORMæ¡†æ¶
- **MySQL** - æ•°æ®åº“
- **Druid** - æ•°æ®åº“è¿æ¥æ± 
- **Lombok** - ä»£ç ç®€åŒ–

## å¿«é€Ÿå¼€å§‹

### é…ç½®æ–‡ä»¶

`application.yml` - æ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨ç›¸åŒé…ç½®

```yaml
server:
  port: 7082

spring:
  application:
    name: biometric-serv
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://192.168.10.147:3306/medicare_test
    username: root
    password: 123456
    druid:
      initial-size: 5
      min-idle: 5
      max-active: 20

hazelcast:
  cluster:
    name: biometric-cluster
  members: 192.168.57.225,192.168.57.100

biometric:
  face:
    recognition:
      threshold: 0.6
      topN: 10
    autoload: true
    partition: true

logging:
  level:
    com.biometric.serv: INFO
    com.biometric.algo: INFO
    com.hazelcast: WARN
```

### å¯åŠ¨åº”ç”¨

```bash
# èŠ‚ç‚¹1
java -jar biometric-serv.jar

# èŠ‚ç‚¹2  
java -jar biometric-serv.jar

# èŠ‚ç‚¹3
java -jar biometric-serv.jar
```

**è¯´æ˜**: æ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨ç›¸åŒé…ç½®å’Œå‘½ä»¤ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…èŠ‚ç‚¹IDã€‚

## åˆ†å¸ƒå¼åŠ è½½åŸç†

### è‡ªåŠ¨èŠ‚ç‚¹IDæ£€æµ‹

1. ä»é…ç½®è¯»å– `hazelcast.members` åˆ—è¡¨
2. è®¡ç®—èŠ‚ç‚¹æ€»æ•°ï¼ˆé€—å·åˆ†éš”çš„æˆå‘˜æ•°é‡ï¼‰
3. è·å– Hazelcast é›†ç¾¤æ‰€æœ‰æˆå‘˜
4. æŒ‰ "IP:ç«¯å£" å­—ç¬¦ä¸²æ’åº
5. å½“å‰èŠ‚ç‚¹åœ¨æ’åºä¸­çš„ä½ç½® = èŠ‚ç‚¹ID

### æ•°æ®åˆ†ç‰‡ç®—æ³•

```java
hash(faceId) % totalNodes = targetNodeId
```

- æ¯ä¸ªèŠ‚ç‚¹åªåŠ è½½ `hash % totalNodes == nodeId` çš„æ•°æ®
- æ•°æ®é€šè¿‡ Hazelcast è‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹
- æ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½è®¿é—®å…¨éƒ¨æ•°æ®

### åŠ è½½æ—¥å¿—ç¤ºä¾‹

```
========== å¼€å§‹åŠ è½½äººè„¸ç‰¹å¾æ•°æ®åˆ° Hazelcast ==========
ä½¿ç”¨é…ç½®æ–‡ä»¶çš„æˆå‘˜æ•°é‡: 2 (æ¥è‡ª hazelcast.members)
è‡ªåŠ¨æ£€æµ‹èŠ‚ç‚¹ä¿¡æ¯æˆåŠŸ:
  - å½“å‰èŠ‚ç‚¹åœ°å€: 192.168.57.100:5701
  - å½“å‰èŠ‚ç‚¹ID: 0
  - é›†ç¾¤æˆå‘˜åˆ—è¡¨:
    [0] 192.168.57.100:5701 <- å½“å‰èŠ‚ç‚¹
    [1] 192.168.57.225:5701
èŠ‚ç‚¹é…ç½®: å½“å‰èŠ‚ç‚¹ID=0, æ€»èŠ‚ç‚¹æ•°=2, åˆ†åŒºåŠ è½½=true (è‡ªåŠ¨æ£€æµ‹)
æ•°æ®åº“æŸ¥è¯¢åˆ° 10000 æ¡äººè„¸ç‰¹å¾æ•°æ®
========== äººè„¸ç‰¹å¾æ•°æ®åŠ è½½å®Œæˆ ==========
æ•°æ®åº“æ€»è®°å½•æ•°: 10000
åˆ†åŒºåŠ è½½ - å½“å‰èŠ‚ç‚¹å¤„ç†: 5023, è·³è¿‡(ç”±å…¶ä»–èŠ‚ç‚¹å¤„ç†): 4977
åŠ è½½ç»“æœ - æˆåŠŸ: 5023, å¤±è´¥: 0
```

## API æ¥å£

### äººè„¸è¯†åˆ«

**POST** `/api/biometric/face/recognize`

è¯†åˆ«äººè„¸å¹¶è¿”å›æœ€åŒ¹é…çš„ç»“æœã€‚

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "è¯†åˆ«å®Œæˆ",
  "data": {
    "results": [
      {
        "faceId": "345854003557139474",
        "psnNo": "110101199001011234",
        "similarity": 0.95,
        "matched": true
      }
    ],
    "count": 1,
    "costTime": 125
  }
}
```

### æ‰‹åŠ¨åŠ è½½æ•°æ®

**POST** `/api/face/load/all`

æ‰‹åŠ¨è§¦å‘å…¨é‡åŠ è½½äººè„¸ç‰¹å¾æ•°æ®ã€‚

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalCount": 10000,
    "message": "äººè„¸ç‰¹å¾æ•°æ®åŠ è½½å·²å¯åŠ¨",
    "costTime": 50
  }
}
```

### æŸ¥è¯¢æ•°æ®æ€»æ•°

**GET** `/api/face/load/count`

æŸ¥è¯¢æ•°æ®åº“ä¸­äººè„¸ç‰¹å¾æ•°æ®æ€»æ•°ã€‚

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalCount": 10000
  }
}
```

## é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `server.port` | æœåŠ¡ç«¯å£ | 7082 |
| `hazelcast.cluster.name` | é›†ç¾¤åç§° | biometric-cluster |
| `hazelcast.members` | é›†ç¾¤æˆå‘˜åˆ—è¡¨ | 127.0.0.1 |
| `biometric.face.recognition.threshold` | è¯†åˆ«é˜ˆå€¼ | 0.6 |
| `biometric.face.recognition.topN` | è¿”å›ç»“æœæ•°é‡ | 10 |
| `biometric.face.autoload` | å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ | false |
| `biometric.face.partition` | å¯ç”¨åˆ†åŒºåŠ è½½ | true |

## æ•°æ®åº“è¡¨ç»“æ„

### bosg_face_ftur_d

äººè„¸ç‰¹å¾æ•°æ®è¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| face_bosg_id | varchar | äººè„¸ç‰¹å¾ID (ä¸»é”®) |
| psn_tmpl_no | varchar | äººå‘˜æ¨¡æ¿å· |
| certno | varchar | è¯ä»¶å·ç  |
| psn_name | varchar | äººå‘˜å§“å |
| face_ftur_data | blob | äººè„¸ç‰¹å¾æ•°æ® (512å­—èŠ‚) |
| face_tmpl_stas | varchar | äººè„¸æ¨¡æ¿çŠ¶æ€ |
| vali_flag | varchar | æœ‰æ•ˆæ ‡å¿— |
| crte_time | datetime | åˆ›å»ºæ—¶é—´ |
| updt_time | datetime | æ›´æ–°æ—¶é—´ |

## éƒ¨ç½²æ¶æ„

### å•èŠ‚ç‚¹éƒ¨ç½²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æœåŠ¡å™¨      â”‚
â”‚  â”œâ”€ Spring Boot â”‚
â”‚  â”œâ”€ Hazelcast   â”‚
â”‚  â””â”€ MySQL       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¤šèŠ‚ç‚¹é›†ç¾¤éƒ¨ç½²

```
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  MySQL   â”‚
                 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                       â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   èŠ‚ç‚¹1      â”‚ â”‚   èŠ‚ç‚¹2      â”‚ â”‚   èŠ‚ç‚¹3      â”‚
â”‚ ID=0 è‡ªåŠ¨   â”‚ â”‚ ID=1 è‡ªåŠ¨   â”‚ â”‚ ID=2 è‡ªåŠ¨   â”‚
â”‚ åŠ è½½33%æ•°æ® â”‚ â”‚ åŠ è½½33%æ•°æ® â”‚ â”‚ åŠ è½½34%æ•°æ® â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
              Hazelcast é›†ç¾¤
        (æ‰€æœ‰èŠ‚ç‚¹å…±äº«100%æ•°æ®)
```

## æ‰©å±•èŠ‚ç‚¹

æ·»åŠ æ–°èŠ‚ç‚¹æ­¥éª¤ï¼š

1. æ›´æ–° `hazelcast.members` é…ç½®ï¼Œæ·»åŠ æ–°èŠ‚ç‚¹åœ°å€
2. ä½¿ç”¨ç›¸åŒé…ç½®å¯åŠ¨æ–°èŠ‚ç‚¹
3. ç³»ç»Ÿè‡ªåŠ¨é‡æ–°è®¡ç®—èŠ‚ç‚¹IDå’Œæ•°æ®åˆ†ç‰‡

**ç¤ºä¾‹**: æ‰©å±•åˆ°3ä¸ªèŠ‚ç‚¹

```yaml
hazelcast:
  members: 192.168.57.225,192.168.57.100,192.168.57.101
```

èŠ‚ç‚¹IDè‡ªåŠ¨åˆ†é…ï¼š
- 192.168.57.100 â†’ ID: 0
- 192.168.57.101 â†’ ID: 1  
- 192.168.57.225 â†’ ID: 2

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–

```sql
CREATE INDEX idx_vali_flag ON bosg_face_ftur_d(vali_flag);
CREATE INDEX idx_face_tmpl_stas ON bosg_face_ftur_d(face_tmpl_stas);
```

### JVM å‚æ•°

```bash
java -Xms2g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -jar biometric-serv.jar
```

### Hazelcast ä¼˜åŒ–

```java
evictionConfig.setSize(10000000);           // æ¯èŠ‚ç‚¹æœ€å¤§æ¡ç›®æ•°
faceFeatureMapConfig.setBackupCount(1);      // å¤‡ä»½æ•°é‡
faceFeatureMapConfig.setAsyncBackupCount(1); // å¼‚æ­¥å¤‡ä»½æ•°é‡
```

## ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

- é›†ç¾¤æˆå‘˜æ•°é‡
- æ•°æ®åŠ è½½æˆåŠŸç‡
- è¯†åˆ«å“åº”æ—¶é—´
- å†…å­˜ä½¿ç”¨ç‡
- GCé¢‘ç‡

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
curl http://localhost:7082/actuator/health

# æŸ¥çœ‹æ•°æ®æ€»æ•°
curl http://localhost:7082/api/face/load/count
```

## å¸¸è§é—®é¢˜

**Q: èŠ‚ç‚¹é‡å¯åæ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ**  
A: ä¸ä¼šã€‚Hazelcastæœ‰å¤‡ä»½æœºåˆ¶ï¼Œä¸”é‡å¯åä¼šä»æ•°æ®åº“é‡æ–°åŠ è½½ã€‚

**Q: å¦‚ä½•éªŒè¯æ•°æ®åŠ è½½æ­£ç¡®ï¼Ÿ**  
A: æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹æ—¥å¿—ï¼Œå„èŠ‚ç‚¹"åŠ è½½æˆåŠŸ"æ•°é‡æ€»å’Œåº”ç­‰äºæ•°æ®åº“æ€»è®°å½•æ•°ã€‚

**Q: èŠ‚ç‚¹é—´å¦‚ä½•é€šä¿¡ï¼Ÿ**  
A: é€šè¿‡ Hazelcast çš„ TCP/IP ç›´è¿æ–¹å¼ï¼Œè‡ªåŠ¨å‘ç°å’Œé€šä¿¡ã€‚

**Q: æ”¯æŒåŠ¨æ€æ‰©ç¼©å®¹å—ï¼Ÿ**  
A: æ”¯æŒã€‚æ›´æ–°é…ç½®åé‡å¯å³å¯ï¼ŒèŠ‚ç‚¹IDå’Œæ•°æ®åˆ†ç‰‡è‡ªåŠ¨è°ƒæ•´ã€‚

**Q: è¯†åˆ«æ€§èƒ½å¦‚ä½•ï¼Ÿ**  
A: å•æ¬¡è¯†åˆ«é€šå¸¸åœ¨100-300mså†…å®Œæˆï¼ˆå–å†³äºæ•°æ®é‡å’Œé˜ˆå€¼è®¾ç½®ï¼‰ã€‚

## æ•…éšœæ’æŸ¥

### é›†ç¾¤æ— æ³•ç»„å»º

1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
2. ç¡®è®¤é˜²ç«å¢™ç«¯å£ï¼ˆ5701-5800ï¼‰å·²å¼€æ”¾
3. éªŒè¯ `hazelcast.members` é…ç½®æ­£ç¡®

### æ•°æ®åŠ è½½å¤±è´¥

1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. éªŒè¯è¡¨ç»“æ„å’Œå­—æ®µ
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯ä¿¡æ¯

### è¯†åˆ«ä¸å‡†ç¡®

1. è°ƒæ•´ `threshold` å‚æ•°
2. æ£€æŸ¥ç‰¹å¾æ•°æ®è´¨é‡
3. éªŒè¯ç®—æ³•ç‰ˆæœ¬ä¸€è‡´æ€§

## è®¸å¯è¯

Copyright Â© 2025

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

