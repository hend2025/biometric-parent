version: '3.8'

services:
  # MySQL数据库
  mysql:
    image: mysql:5.7
    container_name: biometric-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: biometric
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./biometric-serv/src/main/resources/db/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - biometric-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 算法服务节点1
  algo-node1:
    build:
      context: ./biometric-algo
      dockerfile: Dockerfile
    container_name: biometric-algo-node1
    environment:
      - JAVA_OPTS=-Xmx4g -Xms4g -XX:+UseG1GC
      - HAZELCAST_MEMBERS=algo-node1,algo-node2,algo-node3
      - HAZELCAST_PORT=5701
    ports:
      - "8081:8081"
      - "5701:5701"
    networks:
      - biometric-network
    depends_on:
      - mysql

  # 算法服务节点2
  algo-node2:
    build:
      context: ./biometric-algo
      dockerfile: Dockerfile
    container_name: biometric-algo-node2
    environment:
      - JAVA_OPTS=-Xmx4g -Xms4g -XX:+UseG1GC
      - HAZELCAST_MEMBERS=algo-node1,algo-node2,algo-node3
      - HAZELCAST_PORT=5702
      - SERVER_PORT=8082
    ports:
      - "8082:8082"
      - "5702:5702"
    networks:
      - biometric-network
    depends_on:
      - mysql
      - algo-node1

  # 算法服务节点3
  algo-node3:
    build:
      context: ./biometric-algo
      dockerfile: Dockerfile
    container_name: biometric-algo-node3
    environment:
      - JAVA_OPTS=-Xmx4g -Xms4g -XX:+UseG1GC
      - HAZELCAST_MEMBERS=algo-node1,algo-node2,algo-node3
      - HAZELCAST_PORT=5703
      - SERVER_PORT=8083
    ports:
      - "8083:8083"
      - "5703:5703"
    networks:
      - biometric-network
    depends_on:
      - mysql
      - algo-node1

  # 业务服务
  serv:
    build:
      context: ./biometric-serv
      dockerfile: Dockerfile
    container_name: biometric-serv
    environment:
      - JAVA_OPTS=-Xmx2g -Xms2g -XX:+UseG1GC
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/biometric?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - BIOMETRIC_ALGO_URL=http://algo-node1:8081
    ports:
      - "8080:8080"
    networks:
      - biometric-network
    depends_on:
      mysql:
        condition: service_healthy
      algo-node1:
        condition: service_started

networks:
  biometric-network:
    driver: bridge

volumes:
  mysql-data:

